<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="Web Developer" />
    <meta name="author" content="Marks Duarte" />
    <meta
      property="og:url"
      content="https://marksduarte.dev/pages/java/spring-boot-admin.html"
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:title"
      content="Como registrar uma aplicação cliente num servidor de monitoramento
    Spring Boot Admin."
    />
    <meta
      property="og:description"
      content="Como registrar uma aplicação cliente num servidor de monitoramento
    Spring Boot Admin."
    />
    <meta property="og:image" content="https://marksduarte.dev/img/logo.jpg" />

    <title>Configurar Spring Boot Admin</title>

    <!-- Custom fonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat:400,700"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic"
      rel="stylesheet"
      type="text/css"
    />

    <!-- Theme CSS -->
    <link href="/css/marksduarte.min.css" rel="stylesheet" />

    <link rel="icon" type="image/png" sizes="192x192" href="/img/logo.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/img/logo.png" />
    <link rel="icon" type="image/png" sizes="96x96" href="/img/logo.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/img/logo.png" />

    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="msapplication-TileImage" content="/img/logo.png" />
    <meta name="theme-color" content="#ffffff" />
  </head>

  <body id="tips">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg text-uppercase fixed-top" id="mainNav">
      <div class="container">
        <a class="navbar-brand js-scroll-trigger" href="/index.html"
          >Marks Duarte</a
        >
        <button
          class="navbar-toggler navbar-toggler-right text-uppercase font-weight-bold bg-primary text-white rounded"
          type="button"
          data-toggle="collapse"
          data-target="#navbarResponsive"
          aria-controls="navbarResponsive"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          Menu
          <i class="fas fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item mx-0 mx-lg-1">
              <a
                class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger"
                href="/index.html#tips"
                >Home</a
              >
            </li>
            <li class="nav-item mx-0 mx-lg-1">
              <a
                class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger"
                href="#tips"
                >Dicas</a
              >
            </li>
            <li class="nav-item mx-0 mx-lg-1">
              <a
                type="button"
                id="openWhatsappAPIModal"
                data-toggle="modal"
                data-target="#waAPI"
                class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger"
                >WhatsApp API</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Content Section -->
    <section class="page-section">
      <div class="container">
        <h2
          class="page-section-heading text-center text-uppercase text-secondary mb-0 pt-lg-5"
        >
          Como registrar uma aplicação cliente num servidor de monitoramento
          Spring Boot Admin.
        </h2>

        <div class="divider-custom">
          <div class="divider-custom-line"></div>
          <div class="divider-custom-icon">
            <i class="fas fa-laptop-code"></i>
          </div>
          <div class="divider-custom-line"></div>
        </div>

        <article class="lead text-justify">
          <p>
            Existem várias formas de se monitorar sistemas distribuídos e uma
            que me agrada bastante pela simplicidade de configuração e
            confiabilidade é o Spring Boot Admin.
          </p>
          <p>
            Nesse tutorial criaremos duas aplicações utilizando o Spring Boot,
            uma que será o servidor de monitoramento e a outra, o cliente que
            deverá se registrar para ser monitorado.
          </p>
          <p>
            Também vamos aproveitar para implementar uma camada de segurança
            utilizando o Spring Security e com o #Maven, poderemos fazer o build
            das aplicações para serem executadas individualmente.
          </p>
          <h3>Versões utilizadas</h3>
          <ul>
            <li>Spring Boot: 2.7.10</li>
            <li>Spring Boot Admin Server: 2.7.10</li>
            <li>Spring Boot Admin Client: 2.7.10</li>
          </ul>
          <br />
          <h3>Configurando o Servidor</h3>
          <p>
            Crie um projeto utilizando o Spring Initilizr com as seguintes
            dependências:
          </p>
          <ul>
            <li>Starter Web</li>
            <li>Starter Security</li>
            <li>Admin Starter Server</li>
          </ul>
          <img
            src="../../img/pages/sba1.jpeg"
            alt="tela spring initializr"
            class="img-fluid"
          />
          <p>
            Confira se as dependências relacionadas ao Spring Boot Admin foram
            adicionadas:
          </p>
          <pre>
              <code>
    ...
    &lt;dependency&gt;
        &lt;groupId&gt;de.codecentric&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-admin-starter-server&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;de.codecentric&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-admin-server-ui&lt;/artifactId&gt;
    &lt;/dependency&gt;
    ...
              </code>
            </pre>
          <p>
            Adicione a anotação @EnableAdminServer em alguma classe de
            configuração:
          </p>
          <pre>

              <code>
    ...

    @EnableAdminServer
    @SpringBootApplication
    public class SpringBootAdminServerApplication {

        public static void main(String[] args) {
            SpringApplication.run(SpringBootAdminServerApplication.class, args);
        }

    }
              </code>
            </pre>

          <p>
            Configure o comportamento da aplicação utilizando o arquivo
            application.yaml. Como adicionamos uma camada de segurança, devemos
            criar um nome de usuário e senha para logarmos no servidor e também
            será necessário configurar o login para comunicação entre servidor e
            cliente.
          </p>

          <pre>
              <code>
    server:
      port: 8081
      servlet:
        context-path: /admin-console
    spring:
      security:
        user:
          # Configura o login do servidor.
          name: ${SBA_SERVER_USERNAME}
          password: ${SBA_SERVER_PASSWORD}
      boot:
        admin:
          client:
            # Necessários para que o cliente possa se registrar na api do servidor protegido.
            username: ${SBA_SERVER_USERNAME}
            password: ${SBA_SERVER_PASSWORD}
            instance:
              metadata:
                user:
                  # Necessários para que o servidor possa acessar os endpoints protegidos do cliente.
                  name: ${SBA_CLIENT_USERNAME}
                  password: ${SBA_CLIENT_PASSWORD}

    # LOG
    logging:
      file:
        name: ${user.home}/logs/admin/sba-server.log
      level:
        root: info
        web: info
        dev.marksduarte: info
        org.springframework: info
      charset:
        file: utf-8
              </code>
            </pre>

          <p>
            Agora vamos configurar o Spring Security criando uma classe e
            desabilitando o proxy dos beans na anotação
            @Configuration(proxyBeanMethods = false), pois como vamos trabalhar
            com @Bean autocontido, podemos evitar o processamento da subclasse
            CGLIB.
          </p>
          <p>
            Também vamos permitir os acessos às rotas de login e assets e
            desabilitar a proteção CSRF paras o métodos HTTP POST e HTTP DELETE
            nas instâncias dos clientes.
          </p>

          <pre>
              <code>
    package dev.marksduarte.sbaserver;

    ...

    @Configuration(proxyBeanMethods = false)
    public class SecurityConfig {

        private final AdminServerProperties adminServer;

        public SecurityConfig(AdminServerProperties adminServer) {
            this.adminServer = adminServer;
        }

        @Bean
        protected SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
            SavedRequestAwareAuthenticationSuccessHandler successHandler = new SavedRequestAwareAuthenticationSuccessHandler();
            successHandler.setTargetUrlParameter("redirectTo");
            successHandler.setDefaultTargetUrl(this.adminServer.path("/"));

            http.authorizeHttpRequests(authorizeRequests -> authorizeRequests
                            .requestMatchers(new AntPathRequestMatcher(this.adminServer.path("/assets/**")))
                            .permitAll()
                            .requestMatchers(new AntPathRequestMatcher(this.adminServer.path("/login")))
                            .permitAll()
                            .anyRequest()
                            .authenticated())
                    .formLogin(formLogin -> formLogin.loginPage(this.adminServer.path("/login"))
                            .successHandler(successHandler))
                    .logout(logout -> logout.logoutUrl(this.adminServer.path("/logout")))
                    .httpBasic(Customizer.withDefaults())
                    .csrf(csrf -> csrf.csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
                            .ignoringRequestMatchers(
                                    new AntPathRequestMatcher(this.adminServer.path("/instances"), HttpMethod.POST.toString()),
                                    new AntPathRequestMatcher(this.adminServer.path("/instances/*"), HttpMethod.DELETE.toString()),
                                    new AntPathRequestMatcher(this.adminServer.path("/actuator/**"))));

            return http.build();
        }
    }
              </code>
            </pre>

          <p>
            Pronto, agora é só rodar a aplicação e conferir se o Admin Server
            está acessível através do endereço
            <a href="http://localhost:8081/admin-console"
              >http://localhost:8081/admin-console</a
            >
            e logar com o usuário e senha informados na configuração.
          </p>
        </article>

        <article class="lead text-justify">
          <h3>Configurando o Cliente</h3>
          <p>
            Crie um projeto utilizando o Spring Initilizr com as seguintes
            dependências:
          </p>
          <ul>
            <li>Starter Web</li>
            <li>Starter Security</li>
            <li>Starter Actuator</li>
            <li>Admin Starter Server</li>
          </ul>
          <img
            src="../../img/pages/sba2.jpeg"
            alt="tela spring initializr"
            class="img-fluid"
          />
          <p>
            Confira no seu arquivo pom.xml, se a dependência do Spring Boot
            Admin Client e Spring Actuator foram adicionadas:
          </p>

          <pre>
                <code>
    ...
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;de.codecentric&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-admin-starter-client&lt;/artifactId&gt;
        &lt;version&gt;2.7.10&lt;/version&gt;
    &lt;/dependency&gt;
    ...
                </code>
            </pre>

          <p>
            Agora vamos configurar o sistema começando pelo arquivo
            application.yaml:
          </p>
          <pre>
                <code>
    ## INFO ENDPOINT
    ## Aqui configuramos as informações sobre o sistema, como nome, descrição, versão e etc.
    info:
      name: Spring Boot Admin Client
      description: Sistema Cliente
      version: @project.version@

    server:
      port: 8080
      servlet:
        context-path: /admin-client

    spring:
      # Configuração básica do Spring Security.
      security:
        user:
          name: ${SBA_CLIENT_USERNAME}
          password: ${SBA_CLIENT_PASSWORD}
      boot:
        admin:
          client:
            enabled: true
            # URL do servidor que o cliente deve se registrar.
            url: http://localhost:8081/admin-console
            username: ${SBA_SERVER_USERNAME}
            password: ${SBA_SERVER_PASSWORD}
            instance:
              # URL base para calcular o service-url com o qual se registrar. O caminho é inferido em tempo de execução e anexado à url base.
              service-base-url: http://localhost:8080
              # Essas informações são passadas ao servidor para que ele possa fazer o acesso aos endpoints do sistema cliente.
              metadata:
                user:
                  name: ${SBA_SERVER_USERNAME}
                  password: ${SBA_SERVER_PASSWORD}
            auto-deregistration: true

    ## APP
    app:
      cors-origins:
        - http://localhost
      cors-methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      cors-headers:
        - Authorization
        - Content-Type
        - Content-Length
        - X-Requested-With

    ## ACTUATOR
    management:
      info:
        env:
          # Desde o Spring Boot 2.6, o env info é desabilitado por padrão.
          enabled: true
      endpoint:
        health:
          show-details: ALWAYS
          enabled: true
        shutdown:
          enabled: true
        logfile:
          enabled: true
          external-file: logs/sba-client.log
      endpoints:
        web:
          exposure:
            # Liberamos todos os endpoints, mas lembre-se, em produção não se deve fazer isso.
            include: "*"
          cors:
            allowed-headers: ${app.cors-headers}
            allowed-methods: ${app.cors-methods}
            allowed-origins: ${app.cors-origins}

    ## LOG
    logging:
      file:
        name: logs/sba-client.log
        path: logs
      level:
        root: info
        web: info
        dev.marksduarte: info
      charset:
        file: utf-8
      logback:
        rollingpolicy:
          clean-history-on-start: true
          max-file-size: 10MB

                </code>
            </pre>

          <p>
            Para simplificar, vamos habilitar todas as requisições para os
            endpoints do "/actuator/**":
          </p>

          <pre>
                <code>
    package dev.marksduarte.sbaclient
    ...

    @EnableWebSecurity
    @Configuration
    public class SecurityConfig {

        @Bean
        public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
            http.csrf()
                    .disable()
                    .authorizeHttpRequests()
                    .antMatchers("/actuator/**")
                    .permitAll();
            return http.build();
        }
    }
                </code>
            </pre>

          <p>
            Bom, isso já é suficiente para registar nossa aplicação cliente no
            servidor.
          </p>
          <p>
            Mas caso aconteça alguma exceção do tipo:
            HttpMessageNotWritableException ou um response error HTTP 416 ao
            tentar acessar o arquivo de log, não se assuste, isso pode acontecer
            caso seu sistema tenha alguma classe de configuração do Jackson que
            estenda WebMvcConfigurationSupport.
          </p>
          <p>
            Nesse caso, essa classe pode estar desativando a instanciação dos
            Beans com as configurações padrões do Spring Boot.
          </p>
          <p>
            Para corrigir esse tipo de problema, podemos criar um Bean
            customizado e substituir a configuração padrão criada na
            inicialização do sistema.
          </p>

          <pre>
                <code>
    package dev.marksduarte.sbaclient
    ...
    @Configuration
    public class JacksonConfig extends WebMvcConfigurationSupport {

        private final Jackson2ObjectMapperBuilder builder = Jackson2ObjectMapperBuilder.json();

        private static final List&lt;MediaType&gt; MEDIA_TYPE_LIST = List.of(
                MediaType.ALL,
                MediaType.parseMediaType("application/vnd.spring-boot.actuator.v2+json")
        );

        @Bean
        public MappingJackson2HttpMessageConverter customMappingJackson2HttpMessageConverter() {
            MappingJackson2HttpMessageConverter converter = actuatorConverter();
            converter.setSupportedMediaTypes(MEDIA_TYPE_LIST);
            return converter;
        }

        private MappingJackson2HttpMessageConverter actuatorConverter() {
            return new MappingJackson2HttpMessageConverter(builder.build()) {
                @Override
                protected boolean canWrite(MediaType mediaType) {
                    // O método super, retorna true se for null.
                    // Assim evitamos a exceção _HttpMessageNotWritableException_ caso o Content-Type 'null' seja enviado.
                    return mediaType != null && super.canWrite(mediaType);
                }
            };
        }

        @Override
        protected void extendMessageConverters(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters) {
            /*
            Remove somente o MappingJackson2HttpMessageConverter
    padrão e substitui pelo customMappingJackson2HttpMessageConverter.
             */
            var defaultHttpConverterOpt = converters.stream()
                    .filter(MappingJackson2HttpMessageConverter.class::isInstance)
                    .findFirst();

            defaultHttpConverterOpt.ifPresent(converters::remove);
            converters.add(customMappingJackson2HttpMessageConverter());
        }
    }
                </code>
            </pre>

          <img
            src="../../img/pages/sba3.png"
            alt="tela spring initializr"
            class="img-fluid"
          />
          <img
            src="../../img/pages/sba4.png"
            alt="tela spring initializr"
            class="img-fluid"
          />

          <p>
            Código disponível no
            <a href="https://github.com/marksduarte/spring-boot-admin">Github</a
            >.
          </p>

          <p>Por enquanto é só. Até mais! ;)</p>
        </article>
      </div>
    </section>

    <div class="btn-social-share-group">
      <a
        class="btn btn-outline-secondary btn-social"
        href="https://twitter.com/intent/tweet?text=Como%20registrar%20uma%20aplicação%20cliente%20num%20servidor%20de%20monitoramento
%20Spring%20Boot%20Admin.&amp;url=https%3A%2F%2Fmarksduarte.dev%2Fpages%2Fjava%2Fspring-boot-admin.html"
        target="_blank"
        ><i class="fa fa-twitter"></i
      ></a>
      <a
        class="btn btn-outline-secondary btn-social fb-xfbml-parse-ignore"
        data-href="https://marksduarte.dev/pages/java/spring-boot-admin.html"
        href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fmarksduarte.dev%2Fpages%2Fjava%2Fspring-boot-admin.html&amp;src=sdkpreparse"
        target="_blank"
        ><i class="fa fa-facebook"></i
      ></a>
      <a
        class="btn btn-outline-secondary btn-social"
        href="https://linkedin.com/shareArticle?url=https%3A%2F%2Fmarksduarte.dev%2Fpages%2Fjava%2Fspring-boot-admin.html&title=Como%20registrar%20uma%20aplicação%20cliente%20num%20servidor%20de%20monitoramento
        %20Spring%20Boot%20Admin"
        target="_blank"
        ><i class="fa fa-linkedin"></i
      ></a>
    </div>

    <a
      href="#"
      class="js-scroll-trigger scroll-to-top btn btn-outline-secondary"
    >
      <i class="fas fa-arrow-up"></i>
    </a>

    <!-- Bootstrap core JavaScript -->
    <script src="/vendor/jquery/jquery.min.js"></script>
    <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- Custom scripts for this template -->
    <script src="/js/marksduarte.min.js"></script>
    <script
      src="https://kit.fontawesome.com/c6cff8cc93.js"
      crossorigin="anonymous"
    ></script>
    <script
      async
      defer
      crossorigin="anonymous"
      src="https://connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v16.0"
      nonce="vBWghoca"
    ></script>
    <script
      async
      src="https://platform.twitter.com/widgets.js"
      charset="utf-8"
    ></script>
  </body>
</html>
